<!-- formations.component.html -->
<div class="formations-container">
  <!-- Admin Controls Panel -->
  <div *ngIf="isLoggedIn && userRole === 'admin'" class="admin-controls">
    <button class="admin-btn add-btn" (click)="openFormationForm()">
      <i class="fas fa-plus-circle"></i> Ajouter une Formation
    </button>
  </div>

  <div
    *ngFor="let formation of formations"
    class="formation-card"
    (click)="openDetails(formation)"
  >
    <!-- Admin Actions on Card -->
    <div *ngIf="isLoggedIn && userRole === 'admin'" class="admin-card-actions">
      <button
        class="admin-card-btn edit-btn"
        (click)="editFormation(formation, $event)"
      >
        <i class="fas fa-edit"></i>
      </button>
      <button
        class="admin-card-btn delete-btn"
        (click)="deleteFormation(formation, $event)"
      >
        <i class="fas fa-trash-alt"></i>
      </button>
    </div>

    <div
      class="card-image"
      [style.backgroundImage]="'url(' + formation.imageUrl + ')'"
    ></div>
    <div class="card-content">
      <h3>{{ formation.title }}</h3>
      <p class="description">{{ formation.description }}</p>
      <div class="price-tag">
        {{ formation.prix | currency : "EUR" : "symbol" : "1.2-2" }}
      </div>
    </div>
  </div>
</div>

<!-- Details Modal -->
<div *ngIf="selectedFormation" class="modal-overlay" (click)="closeDetails()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeDetails()">&times;</button>

    <!-- Admin Actions in Detail View -->
    <div
      *ngIf="isLoggedIn && userRole === 'admin'"
      class="admin-detail-actions"
    >
      <button
        class="admin-detail-btn"
        (click)="editFormation(selectedFormation, $event)"
      >
        <i class="fas fa-edit"></i> Modifier
      </button>
      <button
        class="admin-detail-btn delete-detail-btn"
        (click)="deleteFormation(selectedFormation, $event)"
      >
        <i class="fas fa-trash-alt"></i> Supprimer
      </button>
    </div>

    <div
      class="modal-image"
      [style.backgroundImage]="'url(' + selectedFormation.imageUrl + ')'"
    ></div>

    <div class="modal-body">
      <h2>{{ selectedFormation.title }}</h2>
      <p class="modal-description">{{ selectedFormation.description }}</p>

      <div class="details-grid">
        <div class="detail-item">
          <i class="fas fa-clock"></i>
          <span>Durée: {{ selectedFormation.duree }} heures</span>
        </div>
        <div class="detail-item">
          <i class="fas fa-user-tie"></i>
          <span>Formateur: {{ selectedFormation.nomFormateur }}</span>
        </div>
        <div class="detail-item">
          <i class="fas fa-map-marker-alt"></i>
          <span>Mode: {{ selectedFormation.etat }}</span>
        </div>
        <div class="detail-item">
          <i class="fas fa-layer-group"></i>
          <span>Niveau: {{ selectedFormation.niveau }}</span>
        </div>
      </div>

      <div class="price-section">
        <span class="modal-price">{{
          selectedFormation.prix | currency : "EUR" : "symbol" : "1.2-2"
        }}</span>
        <button class="register-btn" (click)="register(selectedFormation)">
          S'inscrire
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Formation Form Modal (Add/Edit) -->
<div
  *ngIf="showFormationForm"
  class="modal-overlay"
  (click)="closeFormationForm()"
>
  <div class="modal-content form-modal" (click)="$event.stopPropagation()">
    <button class="close-btn" (click)="closeFormationForm()">&times;</button>

    <div class="modal-body">
      <h2>
        {{ editMode ? "Modifier la Formation" : "Ajouter une Formation" }}
      </h2>

      <form [formGroup]="formationForm" (ngSubmit)="saveFormation()">
        <div class="form-group">
          <label for="title">Titre</label>
          <input
            type="text"
            id="title"
            formControlName="title"
            class="form-control"
          />
          <div
            *ngIf="
              formationForm.get('title')?.invalid &&
              formationForm.get('title')?.touched
            "
            class="error-message"
          >
            Le titre est obligatoire
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea
            id="description"
            formControlName="description"
            class="form-control"
            rows="4"
          ></textarea>
          <div
            *ngIf="
              formationForm.get('description')?.invalid &&
              formationForm.get('description')?.touched
            "
            class="error-message"
          >
            La description est obligatoire
          </div>
        </div>

        <div class="form-row">
          <div class="form-group half">
            <label for="prix">Prix (€)</label>
            <input
              type="number"
              id="prix"
              formControlName="prix"
              class="form-control"
            />
            <div
              *ngIf="
                formationForm.get('prix')?.invalid &&
                formationForm.get('prix')?.touched
              "
              class="error-message"
            >
              Le prix est obligatoire
            </div>
          </div>

          <div class="form-group half">
            <label for="duree">Durée (heures)</label>
            <input
              type="number"
              id="duree"
              formControlName="duree"
              class="form-control"
            />
            <div
              *ngIf="
                formationForm.get('duree')?.invalid &&
                formationForm.get('duree')?.touched
              "
              class="error-message"
            >
              La durée est obligatoire
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="imageUrl">URL de l'image</label>
          <input
            type="text"
            id="imageUrl"
            formControlName="imageUrl"
            class="form-control"
          />
          <div
            *ngIf="
              formationForm.get('imageUrl')?.invalid &&
              formationForm.get('imageUrl')?.touched
            "
            class="error-message"
          >
            L'URL de l'image est obligatoire
          </div>
        </div>

        <div class="form-row">
          <div class="form-group half">
            <label for="niveau">Niveau</label>
            <select id="niveau" formControlName="niveau" class="form-control">
              <option value="Débutant">Débutant</option>
              <option value="Intermediaire">Intermédiaire</option>
              <option value="Avancé">Avancé</option>
            </select>
          </div>

          <div class="form-group half">
            <label for="etat">Mode</label>
            <select id="etat" formControlName="etat" class="form-control">
              <option value="En ligne">En ligne</option>
              <option value="Présentiel">Présentiel</option>
              <option value="Hybride">Hybride</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="nomFormateur">Nom du formateur</label>
          <input
            type="text"
            id="nomFormateur"
            formControlName="nomFormateur"
            class="form-control"
          />
          <div
            *ngIf="
              formationForm.get('nomFormateur')?.invalid &&
              formationForm.get('nomFormateur')?.touched
            "
            class="error-message"
          >
            Le nom du formateur est obligatoire
          </div>
        </div>

        <div class="form-actions">
          <button
            type="button"
            class="cancel-btn"
            (click)="closeFormationForm()"
          >
            Annuler
          </button>
          <button
            type="submit"
            class="save-btn"
            [disabled]="formationForm.invalid"
          >
            {{ editMode ? "Sauvegarder" : "Ajouter" }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Confirmation Dialog for Delete -->
<div
  *ngIf="showDeleteConfirmation"
  class="modal-overlay"
  (click)="cancelDelete()"
>
  <div class="confirmation-modal" (click)="$event.stopPropagation()">
    <h3>Confirmer la suppression</h3>
    <p>Êtes-vous sûr de vouloir supprimer cette formation ?</p>
    <p>
      <strong>{{ formationToDelete?.title }}</strong>
    </p>
    <div class="confirmation-actions">
      <button class="cancel-btn" (click)="cancelDelete()">Annuler</button>
      <button class="delete-confirm-btn" (click)="confirmDelete()">
        Supprimer
      </button>
    </div>
  </div>
</div>
